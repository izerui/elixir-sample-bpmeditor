<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>XMLSerializer.as</title><link rel="stylesheet" type="text/css" href="../SourceStyles.css"/></head><body><pre><span class="ActionScriptComment">///////////////////////////////////////////////////////////////////////////////</span>
<span class="ActionScriptComment">// Licensed Materials - Property of IBM</span>
<span class="ActionScriptComment">// 5724-Z78</span>
<span class="ActionScriptComment">// Â© Copyright IBM Corporation 2007, 2013. All Rights Reserved.</span>
<span class="ActionScriptComment">//</span>
<span class="ActionScriptComment">// Note to U.S. Government Users Restricted Rights:</span>
<span class="ActionScriptComment">// Use, duplication or disclosure restricted by GSA ADP Schedule</span>
<span class="ActionScriptComment">// Contract with IBM Corp.</span>
<span class="ActionScriptComment">///////////////////////////////////////////////////////////////////////////////</span>
<span class="ActionScriptpackage">package</span> serialization
<span class="ActionScriptBracket/Brace">{</span>
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Diagram;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Graph;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Link;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Node;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.PortBase;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Renderer;
  <span class="ActionScriptReserved">import</span> com.ibm.ilog.elixir.diagram.Subgraph;
  
  <span class="ActionScriptReserved">import</span> flash.geom.Point;
  <span class="ActionScriptReserved">import</span> flash.net.getClassByAlias;
  <span class="ActionScriptReserved">import</span> flash.utils.Dictionary;
  <span class="ActionScriptReserved">import</span> flash.utils.describeType;
  <span class="ActionScriptReserved">import</span> flash.utils.getDefinitionByName;
  <span class="ActionScriptReserved">import</span> flash.utils.getQualifiedClassName;
  
  <span class="ActionScriptReserved">import</span> mx.core.IVisualElement;
  <span class="ActionScriptReserved">import</span> mx.formatters.NumberFormatter;
  <span class="ActionScriptReserved">import</span> mx.utils.ObjectUtil;

  <span class="ActionScriptReserved">public</span> class XMLSerializer
  <span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> defaults:Dictionary;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> excluded:Dictionary
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> idsbyClassName:Dictionary;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> objectsByID:Dictionary;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> idsByObject:Dictionary;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> forwardReferences:Array;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> resolvingForwardReferences:Boolean;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> styleDictionary:Dictionary;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> rootProperties:Array;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> numberFormatter:NumberFormatter;
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> stylePropertiesTypes:Dictionary;
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> XMLSerializer()
    <span class="ActionScriptBracket/Brace">{</span>
      styleDictionary = <span class="ActionScriptReserved">new</span> Dictionary();
      numberFormatter = <span class="ActionScriptReserved">new</span> NumberFormatter();
      numberFormatter.useThousandsSeparator = <span class="ActionScriptReserved">false</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Register a set of properties for the root element. These</span>
<span class="ActionScriptASDoc">     * properties are always serialized. </span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">set</span> rootConfiguration(properties:Array):<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      rootProperties = properties;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Register a set of style properties to be serialized for a given class.</span>
<span class="ActionScriptASDoc">     * When serialization of style properties is required, specify the list</span>
<span class="ActionScriptASDoc">     * of properties that will be serialized using this method. And also register</span>
<span class="ActionScriptASDoc">     * a default object initialization function, to initialize the style values</span>
<span class="ActionScriptASDoc">     * in the default object so that their type is correctly specified.</span>
<span class="ActionScriptASDoc">     * </span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> registerStyleProperties(className:String, properties:Array):<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      styleDictionary<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span> = properties;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> reset() : <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      defaults = <span class="ActionScriptReserved">new</span> Dictionary();
      excluded = <span class="ActionScriptReserved">new</span> Dictionary();
      idsbyClassName = <span class="ActionScriptReserved">new</span> Dictionary();
      objectsByID = <span class="ActionScriptReserved">new</span> Dictionary();
      idsByObject = <span class="ActionScriptReserved">new</span> Dictionary();
      forwardReferences = <span class="ActionScriptReserved">new</span> Array();
      resolvingForwardReferences = <span class="ActionScriptReserved">false</span>;
      stylePropertiesTypes = <span class="ActionScriptReserved">new</span> Dictionary();
      
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Retrieve a default object which will be used to indicated</span>
<span class="ActionScriptASDoc">     * when a parameter or style value has to be serialized. It</span>
<span class="ActionScriptASDoc">     * is also used to know the value type for the attribute or style.</span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> getDefaultObject(className:String):Object <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> defaultObject:Object = defaults<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span>;
      <span class="ActionScriptReserved">if</span>(defaultObject == <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        try<span class="ActionScriptBracket/Brace">{</span> 
          <span class="ActionScriptvar">var</span> objclass:Class = getDefinitionByName(className) as Class;
          <span class="ActionScriptReserved">if</span>(objclass != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
            defaultObject = <span class="ActionScriptReserved">new</span> objclass();
            defaults<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span> = defaultObject;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">return</span> defaultObject;
    <span class="ActionScriptBracket/Brace">}</span>
    
        
    <span class="ActionScriptComment">// ---------------------------------------------------------------------</span>
    <span class="ActionScriptComment">// Serialization</span>
    <span class="ActionScriptComment">// ---------------------------------------------------------------------</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Serialize the given object with the tag and all its children.</span>
<span class="ActionScriptASDoc">     * It includes the root properties that have been configured.</span>
<span class="ActionScriptASDoc">     * </span>
<span class="ActionScriptASDoc">     * @see #deserializeTree()</span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> serializeTree(object:Object, rootTag:String) : XML
    <span class="ActionScriptBracket/Brace">{</span>
      reset();
      
      <span class="ActionScriptvar">var</span> root:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<"</span>+rootTag+<span class="ActionScriptString">"></"</span>+rootTag+<span class="ActionScriptString">">"</span>);
      <span class="ActionScriptComment">// Add top level attributes</span>
      serializeConfiguration(object, root);
      <span class="ActionScriptComment">// Add children nodes and links</span>
      serializeChildren(object, root, root);
      <span class="ActionScriptReserved">return</span> root;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Serialize the given object with the tag. </span>
<span class="ActionScriptASDoc">     * </span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> serialize(object:Object, rootTag:String, childrenOnly:Boolean = <span class="ActionScriptReserved">true</span>) : XML
    <span class="ActionScriptBracket/Brace">{</span>
      reset();
      
      <span class="ActionScriptvar">var</span> root:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<"</span>+rootTag+<span class="ActionScriptString">"></"</span>+rootTag+<span class="ActionScriptString">">"</span>);
      
      <span class="ActionScriptReserved">if</span>(childrenOnly)<span class="ActionScriptBracket/Brace">{</span>
        serializeChildren(object, root, root);
      <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> child:XML = serializeObject(object, root);
        <span class="ActionScriptReserved">if</span>(child != <span class="ActionScriptReserved">null</span>)
          root.appendChild(child);
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">return</span> root;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> serializeObject(object:Object, root:XML) : XML
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> className:String = getQualifiedClassName(object);

      <span class="ActionScriptvar">var</span> defaultObject:Object = getDefaultObject(className);      
      <span class="ActionScriptvar">var</span> nameSpace:Namespace = <span class="ActionScriptReserved">null</span>;
      
      <span class="ActionScriptvar">var</span> dotIndex:int = className.lastIndexOf(<span class="ActionScriptString">"::"</span>);
      <span class="ActionScriptReserved">if</span>(dotIndex &gt; 0)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> packageName:String = className.substring(0, dotIndex);
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> ns:Namespace <span class="ActionScriptReserved">in</span> root.namespaceDeclarations())<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">if</span>(ns.uri == packageName)<span class="ActionScriptBracket/Brace">{</span>
            nameSpace = ns;
            break;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">if</span>(nameSpace == <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> prefix:String = <span class="ActionScriptString">""</span>;
          <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> s:String <span class="ActionScriptReserved">in</span> packageName.split(<span class="ActionScriptString">"."</span>))
            prefix += s.charAt(0).toLowerCase();
          nameSpace = <span class="ActionScriptReserved">new</span> Namespace(prefix, packageName);
          root.addNamespace(nameSpace);
        <span class="ActionScriptBracket/Brace">}</span>
        
        className = className.substr(dotIndex + 2);
      <span class="ActionScriptBracket/Brace">}</span>
     
      <span class="ActionScriptvar">var</span> xml:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<"</span>+className+<span class="ActionScriptString">"></"</span>+className+<span class="ActionScriptString">"/>"</span>);
      
      <span class="ActionScriptReserved">if</span>(nameSpace != <span class="ActionScriptReserved">null</span>)
        xml.setNamespace(nameSpace);
      
      <span class="ActionScriptvar">var</span> options:Object = <span class="ActionScriptReserved">new</span> Object();
      options<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"includeReadOnly"</span><span class="ActionScriptBracket/Brace">]</span> = <span class="ActionScriptReserved">false</span>;
      
      <span class="ActionScriptvar">var</span> excludes:Array = excluded<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span> as Array;
      <span class="ActionScriptReserved">if</span>(excludes == <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        excludes = getExcludedProperties(object);
        excluded<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span> = excludes;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptvar">var</span> classInfo:Object = mx.utils.ObjectUtil.getClassInfo(object, excludes, options);
      <span class="ActionScriptvar">var</span> properties:Array = classInfo<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"properties"</span><span class="ActionScriptBracket/Brace">]</span>;
      
      xml.@id = getID(object);
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> property:QName <span class="ActionScriptReserved">in</span> properties)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> propertyName:String = property.localName;
        try <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> v:Object = object<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> defaultValue:Object = defaultObject<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptReserved">if</span>(v != defaultValue)<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> sv:Object = serializeProperty(object, propertyName, v, defaultValue, root);
            <span class="ActionScriptReserved">if</span>(sv is XML)
              xml.appendChild(sv);
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(sv is String)
              xml.@<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span> = sv;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptComment">// ignore property</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      serializeStyle(object, defaultObject, xml, root);
      serializeChildren(object, xml, root);
      
      <span class="ActionScriptReserved">return</span> xml;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> getID(object:Object) : String
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> id:String = idsByObject<span class="ActionScriptBracket/Brace">[</span>object<span class="ActionScriptBracket/Brace">]</span>;
      
      <span class="ActionScriptReserved">if</span>(id == <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptvar">var</span> className:String = getQualifiedClassName(object);
        
        <span class="ActionScriptvar">var</span> count:int = idsbyClassName<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptReserved">if</span>(!count)
          count = 0;
        count++;
        
        <span class="ActionScriptvar">var</span> s:Array = className.split(<span class="ActionScriptString">"::"</span>);
        className = s<span class="ActionScriptBracket/Brace">[</span>s.length-1<span class="ActionScriptBracket/Brace">]</span>;
        
        id = className.charAt(0).toLowerCase() + className.substring(1) + count.toString();
        while(objectsByID<span class="ActionScriptBracket/Brace">[</span>id<span class="ActionScriptBracket/Brace">]</span> != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
          count++;
          id = className.charAt(0).toLowerCase() + className.substring(1) + count.toString();
        <span class="ActionScriptBracket/Brace">}</span>
        
        idsbyClassName<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span> = count;
        
        idsByObject<span class="ActionScriptBracket/Brace">[</span>object<span class="ActionScriptBracket/Brace">]</span> = id;
        objectsByID<span class="ActionScriptBracket/Brace">[</span>id<span class="ActionScriptBracket/Brace">]</span> = object;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> id;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> serializeChildren(object:Object, parent:XML, root:XML) : <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> children:Array = getChildrenToSerialize(object);
      <span class="ActionScriptReserved">if</span>(children != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> childObject:Object <span class="ActionScriptReserved">in</span> children)
        <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> child:XML = serializeObject(childObject, root);
          <span class="ActionScriptReserved">if</span>(child != <span class="ActionScriptReserved">null</span>)
            parent.appendChild(child);
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> getGraph(object:Object) : Graph
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">if</span>(object is Graph)
        <span class="ActionScriptReserved">return</span> Graph(object);
      <span class="ActionScriptReserved">if</span>(object is Diagram)
        <span class="ActionScriptReserved">return</span> Diagram(object).graph;
      <span class="ActionScriptReserved">if</span>(object is Subgraph)<span class="ActionScriptBracket/Brace">{</span>
        Subgraph(object).validateNow();
        <span class="ActionScriptReserved">return</span> Subgraph(object).graph;
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> getChildrenToSerialize(object:Object) : Array
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> graph:Graph = getGraph(object);
      <span class="ActionScriptReserved">if</span>(graph != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> children:Array = <span class="ActionScriptReserved">new</span> Array();
        <span class="ActionScriptReserved">for</span>(<span class="ActionScriptvar">var</span> i:int = 0; i &lt; <span class="MXMLComponent_Tag">graph</span>.numElements; i++)
          children.push(graph.getElementAt(i));
        <span class="ActionScriptReserved">return</span> children;
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> getExcludedProperties(object:Object) : Array
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">if</span>(object is Renderer)
        <span class="ActionScriptReserved">return</span> getRendererProperties();
      <span class="ActionScriptReserved">else</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">new</span> Array();
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> rendererProperties:Array = <span class="ActionScriptReserved">null</span>;
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> getRendererProperties() : Array 
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">if</span>(rendererProperties == <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        rendererProperties = <span class="ActionScriptReserved">new</span> Array();
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> name:QName <span class="ActionScriptReserved">in</span> ObjectUtil.getClassInfo(<span class="ActionScriptReserved">new</span> Renderer())<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"properties"</span><span class="ActionScriptBracket/Brace">]</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> pname:String = name.localName;
          <span class="ActionScriptReserved">if</span>(pname != <span class="ActionScriptString">"left"</span> &&
            pname != <span class="ActionScriptString">"top"</span> &&
            pname != <span class="ActionScriptString">"x"</span> &&
            pname != <span class="ActionScriptString">"y"</span> &&
            pname != <span class="ActionScriptString">"width"</span> &&
            pname != <span class="ActionScriptString">"height"</span>)
            rendererProperties.push(pname);
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">return</span> rendererProperties;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> serializeProperty(object:Object, name:String, value:Object, defaultValue:Object, root:XML) : Object
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">if</span> (object is Node && name == <span class="ActionScriptString">"ports"</span>) <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> ports:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<ports></ports>"</span>);
          <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> port:PortBase <span class="ActionScriptReserved">in</span> Vector.&lt;<span class="MXMLComponent_Tag">PortBase</span>&gt;(value))<span class="ActionScriptBracket/Brace">{</span>
              <span class="ActionScriptvar">var</span> portXML:XML = serializeObject(port, root);
              <span class="ActionScriptReserved">if</span>(portXML != <span class="ActionScriptReserved">null</span>)
                  ports.appendChild(portXML);
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">return</span> ports;
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">if</span> (object is Link) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> (name == <span class="ActionScriptString">"width"</span> || name == <span class="ActionScriptString">"height"</span>)
          <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
        <span class="ActionScriptReserved">if</span> (name == <span class="ActionScriptString">"startNode"</span> || name == <span class="ActionScriptString">"endNode"</span>)
          <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>; <span class="ActionScriptComment">// ports will be saved instead.</span>
        <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"startPort"</span> || name == <span class="ActionScriptString">"endPort"</span>)
          <span class="ActionScriptReserved">return</span> getID(value);
        <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"fallbackStartPoint"</span> || name == <span class="ActionScriptString">"fallbackEndPoint"</span>)
            <span class="ActionScriptReserved">return</span> serializePropertyAsElement(name, value, root);
        <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"intermediatePoints"</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> ipoints:Vector.&lt;<span class="MXMLComponent_Tag">Point</span>&gt; = Vector.&lt;<span class="MXMLComponent_Tag">Point</span>&gt;(value);
          <span class="ActionScriptReserved">if</span>(ipoints != <span class="ActionScriptReserved">null</span> && ipoints.length &gt; 0)<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> points:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<intermediatePoints></intermediatePoints>"</span>);
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> point:Point <span class="ActionScriptReserved">in</span> ipoints)<span class="ActionScriptBracket/Brace">{</span>
              <span class="ActionScriptvar">var</span> pointXML:XML = serializeObject(point, root);
              <span class="ActionScriptReserved">if</span>(pointXML != <span class="ActionScriptReserved">null</span>)
                points.appendChild(pointXML);
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> points;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">if</span> ((object is Graph) || (object is Subgraph)) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> (name == <span class="ActionScriptString">"nodeLayout"</span>) <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">return</span> serializePropertyAsElement(name, value, root);
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> (name == <span class="ActionScriptString">"linkLayout"</span>) <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">return</span> serializePropertyAsElement(name, value, root);
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>

      <span class="ActionScriptReserved">if</span>(value is String) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> propXML:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<"</span>+name+<span class="ActionScriptString">"></"</span>+name+<span class="ActionScriptString">">"</span>);
        propXML.appendChild(String(value));
        <span class="ActionScriptReserved">return</span> propXML;
      <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptReserved">if</span>(value is int || value is Boolean)
        <span class="ActionScriptReserved">return</span> value.toString();
      
      <span class="ActionScriptReserved">if</span>(value is Number && !isNaN(Number(value)))<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">//return Number(value).toFixed();</span>
        <span class="ActionScriptReserved">return</span> numberFormatter.format(value);
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
    <span class="ActionScriptBracket/Brace">}</span>
  
    protected <span class="ActionScriptfunction">function</span> serializePropertyAsElement(name:String, value:Object, root:XML) : XML
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> propXML:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<"</span>+name+<span class="ActionScriptString">"></"</span>+name+<span class="ActionScriptString">">"</span>);
      <span class="ActionScriptvar">var</span> valueXML:XML = serializeObject(value, root);
      <span class="ActionScriptReserved">if</span>(valueXML != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        propXML.appendChild(valueXML);
        <span class="ActionScriptReserved">return</span> propXML;
      <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
      <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Serialize the style information for the given object.</span>
<span class="ActionScriptASDoc">     * The style information required must have been previously</span>
<span class="ActionScriptASDoc">     * registered for the object class.</span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> serializeStyle(object:Object, defaultObject:Object, parent:XML, root:XML): <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> className:String = getQualifiedClassName(object);
      <span class="ActionScriptvar">var</span> styleProperties:Array = styleDictionary<span class="ActionScriptBracket/Brace">[</span>className<span class="ActionScriptBracket/Brace">]</span>;
      
    <span class="ActionScriptReserved">if</span> (styleProperties) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> appendXML:Boolean = <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptvar">var</span> styleXML:XML = <span class="ActionScriptReserved">new</span> XML(<span class="ActionScriptString">"<styles></styles>"</span>);
        
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> styleName:String <span class="ActionScriptReserved">in</span> styleProperties) <span class="ActionScriptBracket/Brace">{</span>
          try <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> v:Object = object.getStyle(styleName);
              <span class="ActionScriptvar">var</span> sv:Object = serializeProperty(object, styleName, v, <span class="ActionScriptReserved">null</span>, root);
              <span class="ActionScriptReserved">if</span>(sv is XML) <span class="ActionScriptBracket/Brace">{</span>
                styleXML.appendChild(sv);
                appendXML = <span class="ActionScriptReserved">true</span>;
              <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(sv is String) <span class="ActionScriptBracket/Brace">{</span>
                styleXML.@<span class="ActionScriptBracket/Brace">[</span>styleName<span class="ActionScriptBracket/Brace">]</span> = sv;
                appendXML = <span class="ActionScriptReserved">true</span>;
              <span class="ActionScriptBracket/Brace">}</span>
          <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// ignore property</span>
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">if</span> (appendXML)
          parent.appendChild(styleXML);        
      <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> serializeConfiguration(object:Object, root:XML):<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> className:String = getQualifiedClassName(object);      
      <span class="ActionScriptvar">var</span> defaultObject:Object = getDefaultObject(className);
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> propertyName:String <span class="ActionScriptReserved">in</span> rootProperties)<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> v:Object = object<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> defaultValue:Object = defaultObject<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptReserved">if</span> (v != defaultValue) <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> sv:Object = serializeProperty(object, propertyName, v, defaultValue, root);
            <span class="ActionScriptReserved">if</span>(sv is XML)
              root.appendChild(sv);
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(sv is String)
              root.@<span class="ActionScriptBracket/Brace">[</span>propertyName<span class="ActionScriptBracket/Brace">]</span> = sv;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptComment">// ignore property</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptComment">// ---------------------------------------------------------</span>
    <span class="ActionScriptComment">// Deserialize</span>
    <span class="ActionScriptComment">// ---------------------------------------------------------</span>
    
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Deserialize the given object with its configuration and all its children.</span>
<span class="ActionScriptASDoc">     * @see #serializeTree()</span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> deserializeTree(object:Object, xml:XML) : Object
    <span class="ActionScriptBracket/Brace">{</span>
      reset();
      
      <span class="ActionScriptvar">var</span> result:Object;
      <span class="ActionScriptComment">// This is the top level graph</span>
      deserializeConfiguration(object, xml);
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> xml.elements())<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> (object.hasOwnProperty(child.localName())) <span class="ActionScriptBracket/Brace">{</span>
          continue;
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> childObject:Object = deserializeObject(child);
          <span class="ActionScriptReserved">if</span>(childObject != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
            addDeserializedChild(object, childObject);
            deserializeChildren(childObject, child);
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      result = object;
            
      resolvingForwardReferences = <span class="ActionScriptReserved">true</span>;
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> ref:Object <span class="ActionScriptReserved">in</span> forwardReferences)<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> obj:Object = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"object"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> name:String = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"name"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> xmlValue:String = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"xmlValue"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> defaultValue:Object = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"defaultValue"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> value:Object = deserializeProperty(obj, name, xmlValue, defaultValue);
          <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
            obj<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span> = value;
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
        
        resolvingForwardReferences = <span class="ActionScriptReserved">true</span>;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> result;
    <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> deserialize(object:Object, xml:XML, childrenOnly:Boolean = <span class="ActionScriptReserved">true</span>) : Object
    <span class="ActionScriptBracket/Brace">{</span>
      reset();
      
      <span class="ActionScriptvar">var</span> result:Object;
      
      
      <span class="ActionScriptReserved">if</span>(childrenOnly)<span class="ActionScriptBracket/Brace">{</span> 
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> xml.elements())<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> childObject:Object = deserializeObject(child);
          <span class="ActionScriptReserved">if</span>(childObject != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
            addDeserializedChild(object, childObject);
            deserializeChildren(childObject, child);
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        result = object;
      <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
        result = deserializeObject(xml);
      <span class="ActionScriptBracket/Brace">}</span>
      
      resolvingForwardReferences = <span class="ActionScriptReserved">true</span>;
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> ref:Object <span class="ActionScriptReserved">in</span> forwardReferences)<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> obj:Object = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"object"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> name:String = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"name"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> xmlValue:String = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"xmlValue"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> defaultValue:Object = ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"defaultValue"</span><span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> value:Object = deserializeProperty(obj, name, xmlValue, defaultValue);
          <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
            obj<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span> = value;
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
        
        resolvingForwardReferences = <span class="ActionScriptReserved">true</span>;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> result;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> deserializeObject(xml:XML) : Object
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> className:String = xml.localName();
      <span class="ActionScriptvar">var</span> ns:Namespace = xml.namespace();
      <span class="ActionScriptReserved">if</span>(ns != <span class="ActionScriptReserved">null</span>)
        className = ns.uri + <span class="ActionScriptString">"::"</span> + className;
      
      try<span class="ActionScriptBracket/Brace">{</span> 
        <span class="ActionScriptvar">var</span> objclass:Class = getDefinitionByName(className) as Class;
        <span class="ActionScriptReserved">if</span>(objclass != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> object:Object = <span class="ActionScriptReserved">new</span> objclass();

          <span class="ActionScriptvar">var</span> id:String = xml.attribute(<span class="ActionScriptString">"id"</span>);
          <span class="ActionScriptReserved">if</span>(id != <span class="ActionScriptReserved">null</span> && id != <span class="ActionScriptString">""</span>)
            objectsByID<span class="ActionScriptBracket/Brace">[</span>id<span class="ActionScriptBracket/Brace">]</span> = object;
          
          <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> att:* <span class="ActionScriptReserved">in</span> xml.attributes())<span class="ActionScriptBracket/Brace">{</span>
            try <span class="ActionScriptBracket/Brace">{</span>
              <span class="ActionScriptvar">var</span> name:String = att.name();
              <span class="ActionScriptvar">var</span> defaultValue:Object = object<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span>;
              <span class="ActionScriptvar">var</span> value:Object = deserializeProperty(object, name, xml.attribute(name), defaultValue);
              <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
                object<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span> = value;
            <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
          <span class="ActionScriptBracket/Brace">}</span>
          
          <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> xml.children())<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span>(object.hasOwnProperty(child.localName()))
            <span class="ActionScriptBracket/Brace">{</span>
              try <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> name1:String = child.localName();
                <span class="ActionScriptvar">var</span> defaultValue1:Object = object<span class="ActionScriptBracket/Brace">[</span>name1<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptvar">var</span> value1:Object = deserializeProperty(object, name1, child, defaultValue1);
                <span class="ActionScriptReserved">if</span>(value1 != <span class="ActionScriptReserved">null</span>)
                  object<span class="ActionScriptBracket/Brace">[</span>name1<span class="ActionScriptBracket/Brace">]</span> = value1;
              <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> (child.localName()==<span class="ActionScriptString">"styles"</span>) <span class="ActionScriptBracket/Brace">{</span>
              deserializeStyle(object,child);
            <span class="ActionScriptBracket/Brace">}</span>
          <span class="ActionScriptBracket/Brace">}</span>
          <span class="ActionScriptReserved">return</span> object;
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span>
        trace(err);
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
    <span class="ActionScriptBracket/Brace">}</span>

    protected <span class="ActionScriptfunction">function</span> deserializeChildren(object:Object, xml:XML) : <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> xml.children()) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">// Style properties for the object are deserialized in deserializeObject</span>
        <span class="ActionScriptReserved">if</span> (child.localName()==<span class="ActionScriptString">"styles"</span>)
          continue;
        <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(!object.hasOwnProperty(child.localName()))
        <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> childObject:Object = deserializeObject(child);
          <span class="ActionScriptReserved">if</span>(childObject != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
            addDeserializedChild(object, childObject);
            deserializeChildren(childObject, child);
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> addDeserializedChild(object:Object, child:Object) : <span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> graph:Graph = getGraph(object);
      <span class="ActionScriptReserved">if</span>(graph != <span class="ActionScriptReserved">null</span> && child is IVisualElement)
        graph.addElement(IVisualElement(child));
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> deserializeProperty(object:Object, name:String, xmlValue:Object, defaultValue:Object) : Object
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptReserved">if</span>(object is Node && name == <span class="ActionScriptString">"ports"</span> && (xmlValue is XML))<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> ports:Vector.&lt;<span class="MXMLComponent_Tag">PortBase</span>&gt; = <span class="ActionScriptReserved">new</span> Vector.&lt;<span class="MXMLComponent_Tag">PortBase</span>&gt;();
        <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> portXML:XML <span class="ActionScriptReserved">in</span> XML(xmlValue).elements())<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> port:PortBase = deserializeObject(portXML) as PortBase;
          <span class="ActionScriptReserved">if</span>(port != <span class="ActionScriptReserved">null</span>)
            ports.push(port);
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">return</span> ports;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">if</span>(object is Link)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"startNode"</span> || name == <span class="ActionScriptString">"endNode"</span> ||
           name == <span class="ActionScriptString">"startPort"</span> || name == <span class="ActionScriptString">"endPort"</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> obj:Object = objectsByID<span class="ActionScriptBracket/Brace">[</span>xmlValue<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptReserved">if</span>(obj != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> obj;
          <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(!resolvingForwardReferences) <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> ref:Object = <span class="ActionScriptReserved">new</span> Object();
            ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"object"</span><span class="ActionScriptBracket/Brace">]</span> = object;
            ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"name"</span><span class="ActionScriptBracket/Brace">]</span> = name;
            ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"xmlValue"</span><span class="ActionScriptBracket/Brace">]</span> = xmlValue;
            ref<span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">"defaultValue"</span><span class="ActionScriptBracket/Brace">]</span> = defaultValue;
            forwardReferences.push(ref);
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"fallbackStartPoint"</span> || name == <span class="ActionScriptString">"fallbackEndPoint"</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">if</span>(xmlValue is XML)
                <span class="ActionScriptReserved">return</span> deserializePropertyAsElement(XML(xmlValue));
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(name == <span class="ActionScriptString">"intermediatePoints"</span>)<span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">if</span>(xmlValue is XML)<span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> points:Vector.&lt;<span class="MXMLComponent_Tag">Point</span>&gt; = <span class="ActionScriptReserved">new</span> Vector.&lt;<span class="MXMLComponent_Tag">Point</span>&gt;();
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> pointXML:XML <span class="ActionScriptReserved">in</span> XML(xmlValue).elements())<span class="ActionScriptBracket/Brace">{</span>
              <span class="ActionScriptvar">var</span> point:Point = deserializeObject(pointXML) as Point;
              <span class="ActionScriptReserved">if</span>(point != <span class="ActionScriptReserved">null</span>)
                points.push(point);
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> points;
            
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">if</span> ((object is Graph) || (object is Subgraph)) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span> ((name == <span class="ActionScriptString">"nodeLayout"</span>) || (name == <span class="ActionScriptString">"linkLayout"</span>)) <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptReserved">if</span> (xmlValue is XML)
            <span class="ActionScriptReserved">return</span> deserializePropertyAsElement(XML(xmlValue));
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptvar">var</span> stringValue:String = String(xmlValue);
      
      <span class="ActionScriptReserved">if</span>(stringValue != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span>(defaultValue is String)
          <span class="ActionScriptReserved">return</span> stringValue;
        
        <span class="ActionScriptReserved">if</span>(defaultValue is int)
          <span class="ActionScriptReserved">return</span> parseInt(stringValue);
        
        <span class="ActionScriptReserved">if</span>(defaultValue is Boolean)
            <span class="ActionScriptReserved">return</span> stringValue == <span class="ActionScriptString">"true"</span> || stringValue == <span class="ActionScriptString">"True"</span>;
        
        <span class="ActionScriptReserved">if</span>(defaultValue is Number || name == <span class="ActionScriptString">"left"</span> || name == <span class="ActionScriptString">"top"</span>)
          <span class="ActionScriptReserved">return</span> parseFloat(stringValue);
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> xmlValue;
    <span class="ActionScriptBracket/Brace">}</span>
    
    protected <span class="ActionScriptfunction">function</span> deserializePropertyAsElement(xmlValue:XML) : Object
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptvar">var</span> elements:XMLList = xmlValue.elements();
        <span class="ActionScriptReserved">if</span>(elements.length() &gt; 0)
            <span class="ActionScriptReserved">return</span> deserializeObject(elements<span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>);
        <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
    <span class="ActionScriptBracket/Brace">}</span>
     
    <span class="ActionScriptASDoc">/**</span>
<span class="ActionScriptASDoc">     * Deserialize attributes and children elements from the </span>
<span class="ActionScriptASDoc">     * <code>styles</code> element. </span>
<span class="ActionScriptASDoc">     */</span>
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> deserializeStyle(object:Object, xml:XML):<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> name:String;
      <span class="ActionScriptvar">var</span> value:Object;
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> att:* <span class="ActionScriptReserved">in</span> xml.attributes())<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          name = att.name();
          value = parseValueFromMedadata(object,name,xml.attribute(name));
          
          <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
            object.setStyle(name, value);
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptComment">// String values are serialized as separate elements.</span>
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> xml.children())<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          name = child.localName();
          value = parseValueFromMedadata(object,name,child);
          <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
            object.setStyle(name, value.toString());
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>      
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> parseValueFromMedadata(object:Object, propertyName:String, xmlValue:Object):Object
    <span class="ActionScriptBracket/Brace">{</span>
      
      <span class="ActionScriptvar">var</span> result:Object;
      <span class="ActionScriptComment">// try dictionary</span>
      <span class="ActionScriptvar">var</span> objectClassName:String = getQualifiedClassName(object);
      <span class="ActionScriptvar">var</span> propertyType:String = stylePropertiesTypes<span class="ActionScriptBracket/Brace">[</span>objectClassName +<span class="ActionScriptString">"."</span> + propertyName<span class="ActionScriptBracket/Brace">]</span>;
      
      <span class="ActionScriptReserved">if</span> (!propertyType) <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">// propertyType not found, need to introspect</span>
        <span class="ActionScriptvar">var</span> describe:* = describeType(object);
        <span class="ActionScriptvar">var</span> objectMetadata:* = describe.metadata;
        
        <span class="ActionScriptComment">// look for the style property on this object</span>
        <span class="ActionScriptvar">var</span> styleProp:XMLList = objectMetadata.(@name==<span class="ActionScriptString">"Style"</span>).arg.(@key==<span class="ActionScriptString">"name"</span>).(@value==propertyName);
        
        <span class="ActionScriptReserved">if</span> (styleProp.length() == 0) <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptComment">// not found on current object, try ancestors classes</span>
          <span class="ActionScriptvar">var</span> ancestorClass:Class;
          <span class="ActionScriptvar">var</span> ancestorClassName:String;
          <span class="ActionScriptvar">var</span> ancestors:XMLList = describe.extendsClass;
          <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> ancestor:XML <span class="ActionScriptReserved">in</span> ancestors)<span class="ActionScriptBracket/Brace">{</span>
            ancestorClassName = (ancestor.@type)<span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>;
            ancestorClass = Class(getDefinitionByName(ancestor.@type));
            objectMetadata = describeType(ancestorClass).factory.metadata;
            styleProp = objectMetadata.(@name==<span class="ActionScriptString">"Style"</span>).arg.(@key==<span class="ActionScriptString">"name"</span>).(@value==propertyName);
            <span class="ActionScriptReserved">if</span> (styleProp.length() != 0) <span class="ActionScriptBracket/Brace">{</span>
              break; 
            <span class="ActionScriptBracket/Brace">}</span>
          <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">if</span> (styleProp.length() &gt; 0) <span class="ActionScriptBracket/Brace">{</span>
          propertyType = (styleProp.parent().arg.(@key==<span class="ActionScriptString">"type"</span>).@value)<span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span>.toString(); 
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// register in dictionary to speed-up future lookups</span>
        stylePropertiesTypes<span class="ActionScriptBracket/Brace">[</span>objectClassName +<span class="ActionScriptString">"."</span> + propertyName<span class="ActionScriptBracket/Brace">]</span> = propertyType;
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptvar">var</span> stringValue:String = String(xmlValue);
      result = stringValue; <span class="ActionScriptComment">// fallback</span>
      
      <span class="ActionScriptReserved">if</span>(stringValue != <span class="ActionScriptReserved">null</span>)<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span>(propertyType == <span class="ActionScriptString">"String"</span>) <span class="ActionScriptBracket/Brace">{</span>
          result = stringValue;
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(propertyType == <span class="ActionScriptString">"uint"</span> || propertyType == <span class="ActionScriptString">"int"</span>) <span class="ActionScriptBracket/Brace">{</span>
          result = parseInt(stringValue);
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(propertyType == <span class="ActionScriptString">"Boolean"</span>) <span class="ActionScriptBracket/Brace">{</span>
          result = stringValue == <span class="ActionScriptString">"true"</span> || stringValue == <span class="ActionScriptString">"True"</span>;
        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span>(propertyType == <span class="ActionScriptString">"Number"</span>) <span class="ActionScriptBracket/Brace">{</span>
          result = parseFloat(stringValue);
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">return</span> result;
    <span class="ActionScriptBracket/Brace">}</span>
    
    <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> deserializeConfiguration(object:Object, root:XML):<span class="ActionScriptReserved">void</span>
    <span class="ActionScriptBracket/Brace">{</span>
      <span class="ActionScriptvar">var</span> className:String = getQualifiedClassName(object);      
      <span class="ActionScriptvar">var</span> defaultObject:Object = getDefaultObject(className);
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> att:* <span class="ActionScriptReserved">in</span> root.attributes())<span class="ActionScriptBracket/Brace">{</span>
        try <span class="ActionScriptBracket/Brace">{</span>
          <span class="ActionScriptvar">var</span> name:String = att.name();
          <span class="ActionScriptvar">var</span> defaultValue:Object = object<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span>;
          <span class="ActionScriptvar">var</span> value:Object = deserializeProperty(object, name, root.attribute(name), defaultValue);
          <span class="ActionScriptReserved">if</span>(value != <span class="ActionScriptReserved">null</span>)
            object<span class="ActionScriptBracket/Brace">[</span>name<span class="ActionScriptBracket/Brace">]</span> = value;
        <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
      
      <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span>(<span class="ActionScriptvar">var</span> child:XML <span class="ActionScriptReserved">in</span> root.children())<span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">if</span>(object.hasOwnProperty(child.localName()))
        <span class="ActionScriptBracket/Brace">{</span>
          try <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> name1:String = child.localName();
            <span class="ActionScriptvar">var</span> defaultValue1:Object = object<span class="ActionScriptBracket/Brace">[</span>name1<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptvar">var</span> value1:Object = deserializeProperty(object, name1, child, defaultValue1);
            <span class="ActionScriptReserved">if</span>(value1 != <span class="ActionScriptReserved">null</span>)
              object<span class="ActionScriptBracket/Brace">[</span>name1<span class="ActionScriptBracket/Brace">]</span> = value1;
          <span class="ActionScriptBracket/Brace">}</span> catch(err:Error)<span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>      
    <span class="ActionScriptBracket/Brace">}</span>
  <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span>
</pre></body></html>